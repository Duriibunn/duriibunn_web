/**
 * Public Data Portal (data.go.kr) API Integration
 * Korean Tourism Organization Tour API (í•œêµ­ê´€ê´‘ê³µì‚¬ Tour API)
 * 
 * API Reference: https://www.data.go.kr/data/15101578/openapi.do
 * Endpoint: https://apis.data.go.kr/B551011/KorService2
 * 
 * Required: VITE_PUBLIC_DATA_API_KEY environment variable
 * 
 * Note: Using Vite proxy to avoid CORS issues
 */

const BASE_URL = '/api/tour'; // Proxy to https://apis.data.go.kr/B551011/KorService2
const API_KEY = import.meta.env.VITE_PUBLIC_DATA_API_KEY || '';

// ë„ì‹œëª… -> ì§€ì—­ì½”ë“œ ë§¤í•‘
const CITY_TO_AREA_CODE: Record<string, number> = {
  'ì„œìš¸': 1,
  'ì¸ì²œ': 2,
  'ëŒ€ì „': 3,
  'ëŒ€êµ¬': 4,
  'ê´‘ì£¼': 5,
  'ë¶€ì‚°': 6,
  'ìš¸ì‚°': 7,
  'ì„¸ì¢…': 8,
  'ê²½ê¸°': 31,
  'ê°•ì›': 32,
  'ê°•ë¦‰': 32,
  'ì¶©ë¶': 33,
  'ì¶©ë‚¨': 34,
  'ê²½ë¶': 35,
  'ê²½ì£¼': 35,
  'ê²½ë‚¨': 36,
  'ì „ë¶': 37,
  'ì „ì£¼': 37,
  'ì „ë‚¨': 38,
  'ì œì£¼': 39,
};

export interface TourPlace {
  contentid: string;
  contenttypeid: string;
  title: string;
  addr1: string;
  addr2?: string;
  tel?: string;
  firstimage?: string;
  firstimage2?: string;
  mapx: string;
  mapy: string;
  mlevel?: string;
  areacode?: string;
  sigungucode?: string;
  cat1?: string;
  cat2?: string;
  cat3?: string;
}

interface ApiResponse {
  response: {
    header: {
      resultCode: string;
      resultMsg: string;
    };
    body: {
      items: {
        item: TourPlace[];
      };
      numOfRows: number;
      pageNo: number;
      totalCount: number;
    };
  };
}

/**
 * ì§€ì—­ ê¸°ë°˜ ê´€ê´‘ì •ë³´ ì¡°íšŒ
 * @param areaCode - ì§€ì—­ ì½”ë“œ (ì„œìš¸: 1, ì¸ì²œ: 2, ëŒ€ì „: 3, ëŒ€êµ¬: 4, ê´‘ì£¼: 5, ë¶€ì‚°: 6, ìš¸ì‚°: 7, ì„¸ì¢…: 8, ê²½ê¸°: 31, ê°•ì›: 32, ì¶©ë¶: 33, ì¶©ë‚¨: 34, ê²½ë¶: 35, ê²½ë‚¨: 36, ì „ë¶: 37, ì „ë‚¨: 38, ì œì£¼: 39)
 * @param sigunguCode - ì‹œêµ°êµ¬ ì½”ë“œ (optional)
 * @param contentTypeId - ì»¨í…ì¸  íƒ€ì… ID (12: ê´€ê´‘ì§€, 14: ë¬¸í™”ì‹œì„¤, 15: ì¶•ì œê³µì—°í–‰ì‚¬, 25: ì—¬í–‰ì½”ìŠ¤, 28: ë ˆí¬ì¸ , 32: ìˆ™ë°•, 38: ì‡¼í•‘, 39: ìŒì‹ì )
 * @param numOfRows - í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜
 * @param pageNo - í˜ì´ì§€ ë²ˆí˜¸
 */
export async function getAreaBasedList(
  areaCode?: number,
  sigunguCode?: number,
  contentTypeId?: number,
  numOfRows: number = 10,
  pageNo: number = 1
): Promise<TourPlace[]> {
  if (!API_KEY) {
    console.error('VITE_PUBLIC_DATA_API_KEY is not set');
    return [];
  }

  const params = new URLSearchParams({
    serviceKey: API_KEY,
    numOfRows: String(numOfRows),
    pageNo: String(pageNo),
    MobileOS: 'ETC',
    MobileApp: 'Dooribun',
    _type: 'json',
    listYN: 'Y',
    arrange: 'A', // A: ì œëª©ìˆœ, B: ì¡°íšŒìˆœ, C: ìˆ˜ì •ì¼ìˆœ, D: ìƒì„±ì¼ìˆœ
  });

  if (areaCode) params.append('areaCode', String(areaCode));
  if (sigunguCode) params.append('sigunguCode', String(sigunguCode));
  if (contentTypeId) params.append('contentTypeId', String(contentTypeId));

  // KorService2ì—ì„œëŠ” ìˆ«ì ì—†ì´ areaBasedList ì‚¬ìš©
  const url = `${BASE_URL}/areaBasedList?${params.toString()}`;
  console.log('ğŸŒ Area API Request:', url);

  try {
    const response = await fetch(url);
    console.log('ğŸ“¡ Area Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data: ApiResponse = await response.json();
    console.log('âœ… Area API success:', data.response.body.totalCount, 'items');

    if (data.response.header.resultCode !== '0000') {
      console.error('API Error:', data.response.header.resultMsg);
      return [];
    }

    return data.response.body.items?.item || [];
  } catch (error) {
    console.error('Failed to fetch area-based list:', error);
    return [];
  }
}

/**
 * í‚¤ì›Œë“œ ê²€ìƒ‰
 * @param keyword - ê²€ìƒ‰ í‚¤ì›Œë“œ
 * @param contentTypeId - ì»¨í…ì¸  íƒ€ì… ID (optional)
 * @param areaCode - ì§€ì—­ ì½”ë“œ (optional)
 * @param numOfRows - í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜
 * @param pageNo - í˜ì´ì§€ ë²ˆí˜¸
 */
// Keyword search
export async function searchKeyword(
  keyword: string,
  contentTypeId?: number,
  areaCode?: number,
  numOfRows: number = 10,
  pageNo: number = 1
): Promise<TourApiItem[]> {
  const endpoint = 'searchKeyword2';
  const params: Record<string, string> = {
    numOfRows: String(numOfRows),
    pageNo: String(pageNo),
    MobileOS: 'ETC',
    MobileApp: 'Dooribun',
    _type: 'json',
    listYN: 'Y',
    arrange: 'A',
    keyword,
  };

/**
 * ìœ„ì¹˜ ê¸°ë°˜ ê´€ê´‘ì •ë³´ ì¡°íšŒ (í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€)
 * @param mapX - GPS Xì¢Œí‘œ (ê²½ë„)
 * @param mapY - GPS Yì¢Œí‘œ (ìœ„ë„)
 * @param radius - ê±°ë¦¬ ë°˜ê²½(m) (1000-20000)
 * @param contentTypeId - ì»¨í…ì¸  íƒ€ì… ID (optional)
 * @param numOfRows - í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜
 * @param pageNo - í˜ì´ì§€ ë²ˆí˜¸
 */
// Location-based list (by GPS coordinates)
export async function locationBasedList(
  mapX: number,
  mapY: number,
  radius: number = 1000,
  contentTypeId?: number,
  numOfRows: number = 10,
  pageNo: number = 1
): Promise<TourApiItem[]> {
  const endpoint = 'locationBasedList2';
  const params: Record<string, string> = {
    numOfRows: String(numOfRows),
    pageNo: String(pageNo),
    MobileOS: 'ETC',
    MobileApp: 'Dooribun',
    _type: 'json',
    listYN: 'Y',
    arrange: 'A',
    mapX: String(mapX),
    mapY: String(mapY),
    radius: String(radius),
  };

/**
 * Content Type IDs
 */
export const CONTENT_TYPES = {
  TOURIST_SPOT: 12, // ê´€ê´‘ì§€
  CULTURE: 14, // ë¬¸í™”ì‹œì„¤
  FESTIVAL: 15, // ì¶•ì œê³µì—°í–‰ì‚¬
  TOUR_COURSE: 25, // ì—¬í–‰ì½”ìŠ¤
  LEISURE_SPORTS: 28, // ë ˆí¬ì¸ 
  ACCOMMODATION: 32, // ìˆ™ë°•
  SHOPPING: 38, // ì‡¼í•‘
  RESTAURANT: 39, // ìŒì‹ì 
} as const;

/**
 * Area Codes (Seoul and major cities)
 */
export const AREA_CODES = {
  SEOUL: 1,
  INCHEON: 2,
  DAEJEON: 3,
  DAEGU: 4,
  GWANGJU: 5,
  BUSAN: 6,
  ULSAN: 7,
  SEJONG: 8,
  GYEONGGI: 31,
  GANGWON: 32,
  CHUNGBUK: 33,
  CHUNGNAM: 34,
  GYEONGBUK: 35,
  GYEONGNAM: 36,
  JEONBUK: 37,
  JEONNAM: 38,
  JEJU: 39,
} as const;

/**
 * Cache for API responses (simple in-memory cache)
 */
const cache = new Map<string, { data: TourPlace[]; timestamp: number }>();
const CACHE_DURATION = 1000 * 60 * 30; // 30 minutes

export function getCachedData(key: string): TourPlace[] | null {
  const cached = cache.get(key);
  if (!cached) return null;
  
  if (Date.now() - cached.timestamp > CACHE_DURATION) {
    cache.delete(key);
    return null;
  }
  
  return cached.data;
}

export function setCachedData(key: string, data: TourPlace[]): void {
  cache.set(key, { data, timestamp: Date.now() });
}

/**
 * Get Seoul tourist spots with caching
 */
export async function getSeoulTouristSpots(numOfRows: number = 10): Promise<TourPlace[]> {
  const cacheKey = `seoul-tourist-${numOfRows}`;
  const cached = getCachedData(cacheKey);
  if (cached) return cached;

  const data = await getAreaBasedList(
    AREA_CODES.SEOUL,
    undefined,
    CONTENT_TYPES.TOURIST_SPOT,
    numOfRows
  );
  
  setCachedData(cacheKey, data);
  return data;
}

/**
 * Get Seoul cultural facilities with caching
 */
export async function getSeoulCulturalFacilities(numOfRows: number = 10): Promise<TourPlace[]> {
  const cacheKey = `seoul-culture-${numOfRows}`;
  const cached = getCachedData(cacheKey);
  if (cached) return cached;

  const data = await getAreaBasedList(
    AREA_CODES.SEOUL,
    undefined,
    CONTENT_TYPES.CULTURE,
    numOfRows
  );
  
  setCachedData(cacheKey, data);
  return data;
}

/**
 * Get Seoul accommodations with caching
 */
export async function getSeoulAccommodations(numOfRows: number = 10): Promise<TourPlace[]> {
  const cacheKey = `seoul-accommodation-${numOfRows}`;
  const cached = getCachedData(cacheKey);
  if (cached) return cached;

  const data = await getAreaBasedList(
    AREA_CODES.SEOUL,
    undefined,
    CONTENT_TYPES.ACCOMMODATION,
    numOfRows
  );
  
  setCachedData(cacheKey, data);
  return data;
}

/**
 * Get Seoul restaurants with caching
 */
export async function getSeoulRestaurants(numOfRows: number = 10): Promise<TourPlace[]> {
  const cacheKey = `seoul-restaurant-${numOfRows}`;
  const cached = getCachedData(cacheKey);
  if (cached) return cached;

  const data = await getAreaBasedList(
    AREA_CODES.SEOUL,
    undefined,
    CONTENT_TYPES.RESTAURANT,
    numOfRows
  );
  
  setCachedData(cacheKey, data);
  return data;
}

/**
 * Get places by city name and content type
 * @param cityName - ë„ì‹œ ì´ë¦„ (í•œê¸€)
 * @param contentTypeId - ì»¨í…ì¸  íƒ€ì… ID
 * @param numOfRows - ê²°ê³¼ ìˆ˜
 */
export async function getPlacesByCity(
  cityName: string,
  contentTypeId: number,
  numOfRows: number = 20
): Promise<TourPlace[]> {
  const areaCode = CITY_TO_AREA_CODE[cityName];
  
  if (!areaCode) {
    console.warn(`Unknown city: ${cityName}, using keyword search`);
    return searchKeyword(cityName, contentTypeId, undefined, numOfRows);
  }

  console.log(`ğŸ—ºï¸ Fetching ${cityName} data using area code ${areaCode}`);
  
  const cacheKey = `city-${areaCode}-type-${contentTypeId}-${numOfRows}`;
  const cached = getCachedData(cacheKey);
  if (cached) {
    console.log('ğŸ“¦ Using cached data');
    return cached;
  }

  const data = await getAreaBasedList(areaCode, undefined, contentTypeId, numOfRows);
  setCachedData(cacheKey, data);
  return data;
}
